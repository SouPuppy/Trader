# 4.x 实验 Reflection 结构和参数化策略介绍

## 概述

4.x 实验系列实现了层级式多资产交易系统，核心创新在于引入了**反思层（Reflection Layer）**，通过动态调整策略参数θ来适应市场变化。本系列包含三个版本：

- **4.1**: 无反思层（Baseline，参数θ固定）
- **4.2**: 每周反思层（Naive Reflection，基于周收益率调整）
- **4.3**: RAG 反思层（RAG Reflection，基于 RAG 系统检索历史数据调整）

## 系统架构

### 三层架构

```
Layer A: Signal Layer（信号层）
  ├── 趋势信号 (Trend)
  ├── 波动率信号 (Volatility)
  ├── 基本面信号 (Fundamental)
  └── 新闻信号 (News)

Layer B: Allocation & RiskControl Layer（分配与风控层）
  ├── ConstrainedAllocator（约束分配器）
  └── 风险控制模块

Layer C: Reflection Layer（反思层）
  ├── 4.1: 无反思（参数θ固定）
  ├── 4.2: 每周反思（Naive Reflection）
  └── 4.3: RAG 反思（RAG Reflection）
```

## 参数化策略（Theta 参数）

### 参数定义

策略通过参数集合 **θ (Theta)** 控制交易行为，包含以下6个核心参数：

| 参数 | 说明 | 取值范围 | 作用 |
|------|------|---------|------|
| `gross_exposure` | 总仓位上限 | [0.0, 1.0] | 控制账户总持仓市值占权益的比例 |
| `max_w` | 单票上限 | [0.01, 0.20] | 限制单个股票的最大配置比例 |
| `turnover_cap` | 换手上限 | [0.0, 0.50] | 限制日/周换手率，控制交易频率 |
| `risk_mode` | 风险模式 | {risk_on, neutral, risk_off} | 风险偏好档位，影响仓位缩放 |
| `enter_th` | 进场阈值 | [0.01, 0.05] | 信号强度阈值，低于此值不进场 |
| `exit_th` | 出场阈值 | [-0.15, -0.08] | 止损阈值，低于此值触发出场 |

### 风险模式说明

| 风险模式 | 缩放因子 | 说明 |
|----------|---------|------|
| `risk_on` | 1.0 | 激进模式，不缩放仓位 |
| `neutral` | 0.8 | 中性模式，降低20%仓位 |
| `risk_off` | 0.5 | 保守模式，降低50%仓位 |

## Reflection 结构

### 4.1: 无反思层（Baseline）

**特点**：参数θ在整个回测期间保持不变

**初始参数**：
| 参数 | 数值 |
|------|------|
| 总仓位上限 (gross_exposure) | 0.85 |
| 单票上限 (max_w) | 0.20 |
| 换手上限 (turnover_cap) | 0.25 |
| 风险模式 (risk_mode) | neutral |
| 进场阈值 (enter_th) | 0.020 |
| 出场阈值 (exit_th) | -0.100 |

**最终参数**：与初始参数相同（无变化）

### 4.2: 每周反思层（Naive Reflection）

**特点**：每周五根据周收益率进行参数调整

**反思机制**：
1. **触发时机**：每周五（周末反思日）
2. **评估指标**：周收益率（账户权益或市场表现）
3. **调整规则**：
   - 周收益率 > 1.5%：适度激进（提高仓位、降低阈值）
   - 周收益率 < -1.5%：更保守（降低仓位、提高阈值）
   - 周收益率在 ±1.5% 范围内：保持参数不变

**初始参数**：
| 参数 | 数值 |
|------|------|
| 总仓位上限 (gross_exposure) | 0.85 |
| 单票上限 (max_w) | 0.20 |
| 换手上限 (turnover_cap) | 0.25 |
| 风险模式 (risk_mode) | neutral |
| 进场阈值 (enter_th) | 0.020 |
| 出场阈值 (exit_th) | -0.100 |

**最终参数**：
| 参数 | 数值 | 变化 |
|------|------|------|
| 总仓位上限 (gross_exposure) | 0.85 | 不变 |
| 单票上限 (max_w) | 0.20 | 不变 |
| 换手上限 (turnover_cap) | 0.26 | +0.01 |
| 风险模式 (risk_mode) | neutral | 不变 |
| 进场阈值 (enter_th) | 0.017 | -0.003 |
| 出场阈值 (exit_th) | -0.080 | +0.020 |

### 4.3: RAG 反思层（RAG Reflection）

**特点**：使用 RAG 系统检索历史数据、新闻、趋势等多维度信息，基于证据生成参数调整建议

**反思机制**：
1. **触发时机**：每周五（周末反思日）
2. **信息检索**：
   - 检索历史价格数据
   - 检索相关新闻
   - 检索市场趋势
   - 检索相似历史场景
3. **决策生成**：
   - LLM 分析检索到的证据
   - 评估策略表现和市场环境
   - 生成参数调整建议（JSON 格式）
4. **回退机制**：如果 RAG 系统证据不足或拒绝调整，回退到 Naive Reflection

**初始参数**：
| 参数 | 数值 |
|------|------|
| 总仓位上限 (gross_exposure) | 0.92 |
| 单票上限 (max_w) | 0.20 |
| 换手上限 (turnover_cap) | 0.30 |
| 风险模式 (risk_mode) | neutral |
| 进场阈值 (enter_th) | 0.015 |
| 出场阈值 (exit_th) | -0.100 |

**最终参数**：
| 参数 | 数值 | 变化 |
|------|------|------|
| 总仓位上限 (gross_exposure) | 0.85 | -0.07 |
| 单票上限 (max_w) | 0.18 | -0.02 |
| 换手上限 (turnover_cap) | 0.25 | -0.05 |
| 风险模式 (risk_mode) | neutral | 不变 |
| 进场阈值 (enter_th) | 0.017 | +0.002 |
| 出场阈值 (exit_th) | -0.100 | 不变 |

## 回测结果对比

### 组合整体表现

| 指标 | 4.1 (无反思) | 4.2 (每周反思) | 4.3 (RAG 反思) |
|------|-------------|---------------|---------------|
| **初始资金** | 1,000,000.00 元 | 1,000,000.00 元 | 1,000,000.00 元 |
| **最终总权益** | 1,492,106.09 元 | 1,497,441.82 元 | 1,310,090.18 元 |
| **总盈亏** | +492,106.09 元 | +497,441.82 元 | +310,090.18 元 |
| **总收益率** | **+49.21%** | **+49.74%** | **+31.01%** |
| **年化收益率 (CAGR)** | **+49.69%** | **+50.23%** | **+31.29%** |

### 风险与稳健性

| 指标 | 4.1 (无反思) | 4.2 (每周反思) | 4.3 (RAG 反思) |
|------|-------------|---------------|---------------|
| **最大回撤 (Max Drawdown)** | 13.91% | 13.10% | 15.07% |
| **年化波动率 (Volatility)** | 22.43% | 22.19% | 17.48% |
| **年化夏普比率 (Sharpe)** | 1.9149 | **1.9497** | 1.6511 |
| **日频夏普比率 (Sharpe Daily)** | 0.1206 | **0.1228** | 0.1040 |
| **年化 Sortino 比率** | 2.4398 | **2.5542** | 1.6866 |
| **Calmar 比率 (CAGR/MaxDD)** | 3.5728 | **3.8346** | 2.0760 |

### 交易统计

| 指标 | 4.1 (无反思) | 4.2 (每周反思) | 4.3 (RAG 反思) |
|------|-------------|---------------|---------------|
| **总交易次数** | 2,098 次 | 2,063 次 | 2,123 次 |
| **买入次数** | 1,192 次 | 1,175 次 | 1,210 次 |
| **卖出次数** | 906 次 | 888 次 | 913 次 |
| **胜率 (Hit Rate)** | 57.06% | **58.45%** | 58.16% |
| **盈亏比 (Profit Factor)** | 1.64 | **1.66** | 1.41 |
| **单笔平均收益** | +535.34 元 | **+552.13 元** | +333.12 元 |
| **平均持仓周期** | 4.2 天 | 4.2 天 | 4.1 天 |

### 执行与成本

| 指标 | 4.1 (无反思) | 4.2 (每周反思) | 4.3 (RAG 反思) |
|------|-------------|---------------|---------------|
| **换手率 (Turnover)** | 7,393.95% | 7,570.58% | 7,905.66% |
| **交易频率 (每日)** | 8.39 次/日 | 8.25 次/日 | 8.49 次/日 |
| **交易频率 (每周)** | 41.96 次/周 | 41.26 次/周 | 42.46 次/周 |

### 尾部风险 (Tail Risk)

| 指标 | 4.1 (无反思) | 4.2 (每周反思) | 4.3 (RAG 反思) |
|------|-------------|---------------|---------------|
| **VaR 95%** | -1.55% | -1.48% | -1.61% |
| **VaR 99%** | -3.33% | -3.48% | -2.68% |
| **CVaR 95%** | -2.33% | -2.32% | -2.36% |
| **CVaR 99%** | -4.15% | -4.19% | -3.69% |
| **极端日跌幅 (5%分位)** | -1.57% | -1.52% | -1.69% |
| **极端日跌幅 (1%分位)** | -3.40% | -3.88% | -3.62% |

## 关键发现

### 1. 反思层效果

- **4.2 (每周反思)** 表现最佳：
  - 总收益率最高（+49.74%）
  - 年化收益率最高（+50.23%）
  - 最大回撤最小（13.10%）
  - 夏普比率最高（1.9497）
  - 胜率和盈亏比最优

- **4.3 (RAG 反思)** 表现保守：
  - 总收益率较低（+31.01%）
  - 年化波动率最低（17.48%），风险控制更严格
  - 最大回撤较大（15.07%），可能因为初始参数更激进

### 2. 参数调整模式

**4.2 (每周反思)** 的参数调整：
- `turnover_cap`: 0.25 → 0.26（+4%）
- `enter_th`: 0.020 → 0.017（-15%）
- `exit_th`: -0.100 → -0.080（+20%）

**4.3 (RAG 反思)** 的参数调整：
- `gross_exposure`: 0.92 → 0.85（-7.6%）
- `max_w`: 0.20 → 0.18（-10%）
- `turnover_cap`: 0.30 → 0.25（-16.7%）
- `enter_th`: 0.015 → 0.017（+13.3%）

### 3. 反思频率

- **4.1**: 无反思（参数固定）
- **4.2**: 每周反思（约50次反思）
- **4.3**: 每周反思（约50次反思，但使用 RAG 系统）

## 总结

1. **参数化策略**：通过6个核心参数θ控制交易行为，实现策略的灵活调整
2. **反思层价值**：每周反思能够根据市场表现动态调整参数，提升策略适应性
3. **简单有效**：4.2 的 Naive Reflection 表现最佳，说明简单的基于收益率的调整规则已经足够有效
4. **RAG 潜力**：4.3 的 RAG Reflection 虽然收益率较低，但波动率更低，在风险控制方面有优势，未来可以通过优化 RAG 检索和提示工程进一步提升

## 技术细节

### Reflection Engine

- 继承自 `BacktestEngine`
- 支持参数θ追踪和历史记录
- 生成参数化报告和可视化图表
- 记录每日参数变化

### 参数调整流程

```
每周五触发反思
  ↓
计算周收益率
  ↓
评估策略表现
  ↓
生成参数调整建议
  ↓
应用新参数
  ↓
更新 Signal Layer 和 Allocator
```

### RAG 反思流程

```
每周五触发反思
  ↓
构建反思问题（包含当前参数、周收益率、账户权益等）
  ↓
RAG 系统检索历史数据、新闻、趋势
  ↓
LLM 分析检索到的证据
  ↓
生成参数调整建议（JSON 格式）
  ↓
解析并验证参数调整
  ↓
如果证据不足，回退到 Naive Reflection
  ↓
应用新参数
```

