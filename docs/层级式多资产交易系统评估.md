# 层级式多资产交易系统 - 现有组件评估

## 一、现有组件能力评估

### ✅ Layer A: Signal层（信号层）- **基本具备**

**现有能力：**
- ✅ 特征系统（`trader/features/`）：trends (ret_1d, ret_5d, ret_20d), volatility (vol_20d, vol_60d), fundamentals (pe_ratio, pb_ratio等)
- ✅ 新闻分析系统（`trader/news/analyze.py`）：可以分析sentiment [-10, 10] 和 impact [0, 10]
- ✅ TradingAgent基类：区分score和weight，有`score()`抽象方法
- ✅ LogisticAgent：可以生成score

**缺失部分：**
- ⚠️ **缺少统一的加权信号层**：需要实现 `score_i(t) = w_T·Trend_i(t) + w_V·VolAdj_i(t) + w_F·Value_i(t) + w_N·News_i(t)`
- ⚠️ 新闻特征需要从数据库读取并整合到信号计算中

**建议：**
- 创建一个新的 `SignalAgent` 或 `CompositeSignalAgent`，实现加权信号组合
- 从特征系统读取trends/fundamentals，从news系统读取sentiment/impact

---

### ✅ Layer B: Allocation & RiskControl层（分配与风控层）- **部分具备**

**现有能力：**
- ✅ TradingAgent的`weight()`方法：可以基于score计算权重
- ✅ `normalize_weights()`函数：可以归一化权重
- ✅ RiskManager接口（`trader/risk/RiskManager.py`）：提供validate/adjust/pre_trade/post_trade接口
- ✅ 基础风险控制：max_position_weight, max_total_weight

**缺失部分：**
- ⚠️ **缺少约束投影机制**：
  - `gross_exposure` 约束：`∑|w_i| ≤ gross_exposure`
  - `turnover_cap` 约束：`∑|w_i(t) - w_i(t-1)| ≤ turnover_cap`
  - `risk_mode` 缩放：risk_on/neutral/risk_off 对总仓位的缩放
- ⚠️ 缺少风险调整的权重计算：`w~_i(t) ∝ max(score_i(t), 0) / σ_i(t)`

**建议：**
- 创建一个 `ConstrainedAllocator` 类，实现约束投影
- 在 `weight()` 方法中集成风险调整和约束投影

---

### ✅ Layer C: LLM Reflection层（反思层）- **RAG系统具备，但缺少反思逻辑**

**现有能力：**
- ✅ **完整的Cited-RAG系统**（`trader/rag/`）：
  - `rag_answer()` 接口：可以检索news/trade_history/trends
  - 支持证据包（evidence pack）构建
  - 支持citation验证和sanitization
  - 支持多种retriever：NewsRetriever, TradeRetriever, TrendsRetriever
- ✅ 回测报告系统（`trader/backtest/report.py`）：
  - 可以计算Sharpe ratio, max drawdown, turnover, win rate等
  - 有daily_records记录每日账户状态
  - 可以计算各资产贡献度

**缺失部分：**
- ⚠️ **缺少反思层的实现**：
  - 定期（如每周）读取交易表现摘要
  - 构建Reflection Packet（交易表现 + 风险指标 + 证据文档）
  - 调用LLM调整参数θ（gross_exposure, max_w, turnover_cap, risk_mode等）
  - 参数θ的结构化JSON输出和校验
- ⚠️ RAG系统目前主要用于gate决策（是否执行交易），而不是参数调整

**建议：**
- 创建一个 `ReflectionLayer` 类，实现定期反思逻辑
- 构建Reflection Packet生成器
- 创建参数θ的结构化schema和校验器

---

### ✅ 回测系统 - **完全具备**

**现有能力：**
- ✅ 完整的回测引擎（`trader/backtest/engine.py`）
- ✅ 账户管理（`trader/backtest/account.py`）
- ✅ 报告生成（`trader/backtest/report.py`）：Sharpe, max drawdown, turnover, win rate等
- ✅ 多资产支持：`MultiAssetLogisticAgentWithRAGGate`

---

## 二、实现方案

### 方案A：最小改动（快速验证）

**步骤：**
1. **Layer A**：创建一个简单的加权信号Agent
   - 复用现有features和news系统
   - 实现 `score_i = w_T*Trend + w_V*VolAdj + w_F*Value + w_N*News`

2. **Layer B**：扩展现有weight()方法
   - 添加约束投影逻辑（gross_exposure, turnover_cap）
   - 添加risk_mode缩放

3. **Layer C**：创建ReflectionLayer
   - 定期（每周）调用，读取daily_records计算表现指标
   - 使用现有RAG系统检索证据
   - 调用LLM生成参数θ的JSON
   - 更新Layer B的参数

**优点：** 快速实现，复用现有组件
**缺点：** 架构不够清晰，参数θ管理分散

---

### 方案B：完整重构（推荐）

**步骤：**
1. **创建新的Agent架构**：
   ```
   HierarchicalMultiAssetAgent
   ├── SignalLayer (Layer A)
   │   ├── TrendSignal
   │   ├── VolatilitySignal
   │   ├── FundamentalSignal
   │   └── NewsSignal
   ├── AllocationLayer (Layer B)
   │   ├── RiskAdjustedAllocator
   │   └── ConstrainedProjector
   └── ReflectionLayer (Layer C)
       ├── PerformanceAnalyzer
       ├── ReflectionPacketBuilder
       └── ParameterUpdater
   ```

2. **参数θ管理**：
   - 创建 `Theta` dataclass，包含所有可调参数
   - 实现参数校验和裁剪
   - 实现参数历史记录

3. **反思层实现**：
   - 每周（或可配置频率）触发反思
   - 构建Reflection Packet
   - 调用RAG系统获取证据
   - LLM生成参数调整建议
   - 更新参数并记录

**优点：** 架构清晰，易于扩展和维护
**缺点：** 需要更多开发时间

---

## 三、可以直接使用的组件

### 1. RAG系统（完全可用）
```python
from trader.rag.answer import rag_answer

# 可以检索news/trade_history/trends
verified_answer = rag_answer(
    question="基于最近交易表现，应该如何调整风险参数？",
    stock_code="AAPL.O",
    decision_time="2024-01-15T00:00:00",
    frequency="1d"
)
```

### 2. 回测报告（完全可用）
```python
from trader.backtest.report import BacktestReport

# daily_records包含每日账户状态
# 可以计算Sharpe, max_drawdown, turnover等
report = BacktestReport()
# report.daily_records 包含所有每日记录
```

### 3. 特征系统（完全可用）
```python
from trader.features import get_feature

# 可以获取trends, volatility, fundamentals
trend = engine.get_feature("ret_20d", stock_code)
vol = engine.get_feature("vol_20d", stock_code)
```

### 4. 新闻分析（完全可用）
```python
from trader.news.analyze import analyze

# 可以分析sentiment和impact
news_data = {...}
result = analyze(news_data)
# result['sentiment']: [-10, 10]
# result['impact']: [0, 10]
```

---

## 四、需要新增的组件

### 1. SignalLayer（信号层）
- 文件：`trader/agent/signal_layer.py`
- 功能：组合trends/fundamentals/news生成统一score

### 2. ConstrainedAllocator（约束分配器）
- 文件：`trader/risk/constrained_allocator.py`
- 功能：实现约束投影（gross_exposure, turnover_cap, risk_mode）

### 3. ReflectionLayer（反思层）
- 文件：`trader/agent/reflection_layer.py`
- 功能：定期反思，调整参数θ

### 4. Theta（参数管理）
- 文件：`trader/agent/theta.py`
- 功能：参数θ的结构化定义和校验

---

## 五、结论

**现有组件可以支持70-80%的需求**，主要缺失：

1. **Layer A**：需要实现加权信号组合（1-2天工作量）
2. **Layer B**：需要实现约束投影（2-3天工作量）
3. **Layer C**：需要实现反思层逻辑（3-5天工作量）

**建议：**
- 先实现方案A（最小改动），快速验证思路
- 如果效果良好，再重构为方案B（完整架构）

**总体评估：可以直接开始实现，现有组件提供了很好的基础。**

