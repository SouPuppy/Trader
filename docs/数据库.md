### 数据库结构

**注意：新闻数据现在直接从 `raw_data` 表的 `news` 字段解析，不再使用单独的 `news_data` 表。**

| CSV 原始列名 | `raw_data` 字段 | 类型 | 说明 | 约束 |
|-------------|----------------|------|------|------|
| (空列) | `id` | INTEGER | 行情记录主键，自增 ID | PRIMARY KEY, AUTOINCREMENT |
| (空列，实际为日期) | `datetime` | TEXT | 行情日期（从 CSV 第一列读取） | |
| `thscode` | `stock_code` | TEXT | 股票代码（同花顺格式，如 AAPL.O） | |
| `昨日收盘价` | `prev_close` | REAL | 昨日收盘价（Previous Close Price） | |
| `开盘价` | `open_price` | REAL | 开盘价（Opening Price） | |
| `最高价` | `high_price` | REAL | 最高价（High Price） | |
| `最低价` | `low_price` | REAL | 最低价（Low Price） | |
| `收盘价` | `close_price` | REAL | 收盘价（Closing Price） | |
| `成交量` | `volume` | REAL | 成交量（单位：股数） | |
| `新闻` | `news` | TEXT | 原始相关新闻内容（JSON 格式字符串） | |
| `市盈率` | `pe_ratio` | REAL | 市盈率（PE） | |
| `市盈率ttm` | `pe_ratio_ttm` | REAL | 滚动市盈率（TTM） | |
| `市现率ttm` | `pcf_ratio_ttm` | REAL | 市现率（TTM） | |
| `市净率` | `pb_ratio` | REAL | 市净率（PB） | |
| `市销率` | `ps_ratio` | REAL | 市销率（PS） | |
| `市销率ttm` | `ps_ratio_ttm` | REAL | 滚动市销率（TTM） | |
| (系统字段) | `analyzed` | INTEGER | 新闻分析状态标记 | DEFAULT 0 |

#### 字段详细说明

**股票标识**
- `stock_code` (CSV: `thscode`): 股票代码，使用同花顺代码格式
  - 格式：`SYMBOL.EXCHANGE`（如：`AAPL.O` 表示苹果公司在纳斯达克）
  - 常见交易所代码：`.O` (NASDAQ), `.N` (NYSE), `.HK` (港交所), `.SH` (上交所), `.SZ` (深交所)

**价格数据**
- 所有价格字段单位为货币单位（通常为美元或人民币）
- `prev_close` (CSV: `昨日收盘价`): 前一个交易日的收盘价
- `open_price` (CSV: `开盘价`): 当日开盘价
- `high_price` (CSV: `最高价`): 当日最高价
- `low_price` (CSV: `最低价`): 当日最低价
- `close_price` (CSV: `收盘价`): 当日收盘价

**交易数据**
- `volume` (CSV: `成交量`): 当日成交股数（单位：股）

**日期时间数据**
- `datetime` (CSV: 第一列，无列名): 行情日期，从 CSV 第一列读取
  - 类型: TEXT
  - 格式: "2023-01-03"（日期格式）
  - 用途: 标识该行情记录对应的日期

**新闻数据**
- `news` (CSV: `新闻`): JSON 格式字符串，包含以下字段：
  ```json
  {
    "publish_time": "2023-01-02 23:15:25",
    "title": "新闻标题",
    "content": "新闻内容（HTML格式）"
  }
  ```
  
  注意：新闻数据现在直接从 `raw_data` 表的 `news` 字段解析。特征计算时会实时解析 JSON 并分析新闻内容（sentiment、impact 等）。

**系统字段**
- `analyzed` (系统字段): 新闻分析状态标记，用于标识新闻是否已被分析处理
  - 类型: INTEGER (BOOLEAN)
  - 默认值: `0` (False，表示未分析)
  - 可能的值:
    - `0` (False): 未分析
    - `1` (True): 已分析
  - 用途: 用于跟踪哪些新闻已经被分析，避免重复处理
  - 查询未分析的新闻: `WHERE analyzed = 0 OR analyzed IS NULL`
  - 查询已分析的新闻: `WHERE analyzed = 1`

**财务指标说明**
- **PE Ratio (市盈率)**: 股价与每股收益的比率，反映股票估值水平
  - 计算公式：`PE = 股价 / 每股收益`
  - 通常 PE 越低，股票越便宜
  - 数据库列名: `pe_ratio` (CSV: `市盈率`)
  
- **PE Ratio TTM (滚动市盈率)**: 基于过去12个月（Trailing Twelve Months）的滚动市盈率
  - 更准确地反映当前估值水平
  - 数据库列名: `pe_ratio_ttm` (CSV: `市盈率ttm`)
  
- **PCF Ratio TTM (市现率TTM)**: 股价与每股现金流的比率
  - 计算公式：`PCF = 股价 / 每股现金流`
  - 反映现金流估值水平
  - 数据库列名: `pcf_ratio_ttm` (CSV: `市现率ttm`)
  
- **PB Ratio (市净率)**: 股价与每股净资产的比率
  - 计算公式：`PB = 股价 / 每股净资产`
  - 反映资产估值水平
  - 数据库列名: `pb_ratio` (CSV: `市净率`)
  
- **PS Ratio (市销率)**: 股价与每股销售额的比率
  - 计算公式：`PS = 股价 / 每股销售额`
  - 反映收入估值水平
  - 数据库列名: `ps_ratio` (CSV: `市销率`)
  
- **PS Ratio TTM (滚动市销率)**: 基于过去12个月的滚动市销率
  - 数据库列名: `ps_ratio_ttm` (CSV: `市销率ttm`)

#### 数据来源

数据从 `data/data.csv` 文件导入，通过 `./script/init_db.sh` 脚本初始化。

**注意**: 如果之前使用的是中文列名的数据库，需要删除旧数据库重新初始化：
```bash
rm data/data.sqlite3
./script/init_db.sh
```

#### 查询示例

```python
import sqlite3
from trader.config import DB_PATH

conn = sqlite3.connect(DB_PATH)
cursor = conn.cursor()

# 查询特定股票的数据（使用英文列名）
cursor.execute("""
    SELECT datetime, stock_code, close_price, volume, pe_ratio 
    FROM raw_data 
    WHERE stock_code = 'AAPL.O'
    ORDER BY id DESC 
    LIMIT 10
""")

# 查询多个字段的示例
cursor.execute("""
    SELECT 
        datetime,
        stock_code,
        prev_close,
        open_price,
        high_price,
        low_price,
        close_price,
        volume,
        pe_ratio,
        pb_ratio
    FROM raw_data 
    WHERE stock_code = 'AAPL.O'
    ORDER BY id DESC 
    LIMIT 10
""")

# 查询未分析的新闻记录
cursor.execute("""
    SELECT 
        id,
        datetime,
        stock_code,
        analyzed
    FROM raw_data 
    WHERE (analyzed = 0 OR analyzed IS NULL) 
      AND news IS NOT NULL 
      AND news != ''
    ORDER BY id ASC
    LIMIT 10
""")

# 统计未分析的新闻数量
cursor.execute("""
    SELECT 
        COUNT(*) as total,
        SUM(CASE WHEN analyzed = 0 OR analyzed IS NULL THEN 1 ELSE 0 END) as unanalyzed,
        SUM(CASE WHEN analyzed = 1 THEN 1 ELSE 0 END) as analyzed
    FROM raw_data
    WHERE news IS NOT NULL AND news != ''
""")

rows = cursor.fetchall()
for row in rows:
    print(row)

conn.close()
```